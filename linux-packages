#!/usr/bin/env bash

source "${BASH_SOURCE%/*}/lib/shared.sh"

case $(uname -m) in
  x86_64) arch=amd64 ;;
  aarch64|arm64) arch=arm64 ;;
  *) echo "unsupported architecture" && exit 1 ;;
esac
readonly arch

# Install starship
function install_starship() {
  if ! command_exists starship ; then
    if is_stripe_devbox ; then
      case "${arch}" in
        arm64) ss_arch=aarch64 ;;
        amd64) ss_arch=x86_64 ;;
        *) exit 1 ;;
      esac

      curl -sSfL "https://artifactory-content.stripe.build/artifactory/github-releases/starship/starship/releases/download/v1.23.0/starship-${ss_arch}-unknown-linux-musl.tar.gz" \
        | sudo tar --no-same-owner -xz -C /usr/local/bin starship
    else
      sudo curl -sS https://starship.rs/install.sh | sh
    fi
  fi
}

function install_github_release() {
  local bin_name="$1"
  local url="$2"

  if [ -x "$HOME/.local/bin/$bin_name" ]; then
    echo "Skipping install of $bin_name, already exists"
    return 0
  fi

  echo "Installing $bin_name from $url"

  mkdir -p ~/.local/bin
  pushd ~/.local/bin >/dev/null || exit

  curl -L "$url" -o "$bin_name"
  chmod +x "$bin_name"

  popd >/dev/null || exit
}

function install_fzf() {
  local target_dir="$HOME/.local/bin"

  if [ -f "$target_dir/fzf" ]; then
    echo "Skipping fzf install, already exists!"
    return 0
  fi

  # Define the URL and the target directory
  local fzf_url="https://github.com/junegunn/fzf/releases/download/v0.60.0/fzf-0.60.0-linux_arm64.tar.gz"
  local tar_file="fzf-0.60.0-linux_arm64.tar.gz"

  # Download the tar.gz file
  curl -L "$fzf_url" -o "$tar_file" || {
    echo "Error downloading $fzf_url"
    return 1
  }

  # Extract the tar.gz file to ~/.local/bin
  tar -xzf "$tar_file" -C "$target_dir" || {
    echo "Error extracting $tar_file"
    return 1
  }

  # Verify that fzf exists
  if [ ! -f "$target_dir/fzf" ]; then
    echo "fzf not found in $target_dir"
    return 1
  fi

  # Set executable permissions
  chmod +x "$target_dir/fzf" || {
    echo "Error setting permissions on $target_dir/fzf"
    return 1
  }

  # Delete the downloaded tar.gz file
  rm "$tar_file"

  echo "fzf installed successfully to $target_dir!"
}

function install_vim_packages() {
  local nvim_binary
  nvim_binary=${1:-nvim}

  # install packages
  if [ -d "$HOME/.local/share/nvim/lazy" ]; then
    echo "Skipping lazy.nvim init install, packages already exist"
  else
    $nvim_binary --headless \
      +':Lazy install' \
      +':TSUpdate' \
      +qa
  fi
}

function install_stripe() {
  install_starship

  install_github_release diff-so-fancy \
    https://github.com/so-fancy/diff-so-fancy/releases/download/v1.4.4/diff-so-fancy

  # Grab the latest nvim dev version (0.11.x at time of writing)
  install_github_release nvim \
    https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-arm64.appimage

  install_vim_packages

  sudo apt-get update

  sudo apt-get install -y \
    autojump \
    bat \
    direnv \
    eza \
    libreadline-dev \
    libreadline8t64 \
    openssl \
    ripgrep \
    tmux \
    tmuxinator \
    wget \
    xz-utils \
    zsh

  install_fzf
}

function setup_avahi() {
  local work_needed=false
  local output=""
  local status=""

  # Check if Avahi is already installed
  if ! pacman -Q avahi nss-mdns &>/dev/null; then
    work_needed=true
    output+="» Installing Avahi and nss-mdns...\n"
    status=$(sudo pacman -S --noconfirm avahi nss-mdns 2>&1) || {
      echo "✗ Failed to install required packages. Exiting."
          echo "$status"
          return 1
        }
  fi

  # Check if Avahi service is enabled
  if ! systemctl is-enabled avahi-daemon.service &>/dev/null; then
    work_needed=true
    output+="» Enabling Avahi daemon...\n"
    status=$(sudo systemctl enable avahi-daemon.service 2>&1) || {
      echo "✗ Failed to enable Avahi daemon. Exiting."
          echo "$status"
          return 1
        }
  fi

  # Check if Avahi service is running
  if ! systemctl is-active avahi-daemon.service &>/dev/null; then
    work_needed=true
    output+="» Starting Avahi daemon...\n"
    status=$(sudo systemctl start avahi-daemon.service 2>&1) || {
      echo "✗ Failed to start Avahi daemon. Exiting."
          echo "$status"
          return 1
        }
  fi

  # Configure nsswitch.conf
  if ! grep -q "mdns_minimal \[NOTFOUND=return\]" /etc/nsswitch.conf; then
    work_needed=true
    output+="» Configuring nsswitch.conf...\n"

    # Create backup
    status=$(sudo cp /etc/nsswitch.conf /etc/nsswitch.conf.bak 2>&1) || {
      echo "✗ Failed to create nsswitch.conf backup. Exiting."
          echo "$status"
          return 1
        }

        # Update the hosts line in nsswitch.conf
        status=$(sudo sed -i 's/^hosts:.*/hosts: mymachines mdns_minimal [NOTFOUND=return] resolve [!UNAVAIL=return] files myhostname dns/' /etc/nsswitch.conf 2>&1) || {
          echo "✗ Failed to modify nsswitch.conf. Exiting."
                  echo "$status"
                  return 1
                }

                # Restart Avahi daemon to apply changes
                output+="» Restarting Avahi daemon to apply changes...\n"
                status=$(sudo systemctl restart avahi-daemon.service 2>&1)
  fi

  if [ "$work_needed" = true ]; then
    echo -e "$output"
    echo "✅ Setup complete! Your computer should now broadcast as $(hostname).local"
    echo "   To test, run: ping -c 3 $(hostname).local"
  else
    echo "✓ Avahi is already fully configured. No changes needed."
  fi
}

function install_arch() {
  # update system
  sudo pacman -Syyu

  # setup yay
  ./arch-aur-setup

  sudo pacman -Syu --noconfirm --needed \
    awk \
    bat \
    curl \
    diff-so-fancy \
    direnv \
    eza \
    fzf \
    git \
    less \
    lua \
    luarocks \
    nano \
    neovim \
    npm \
    openssh \
    openssl \
    python3 \
    rbenv \
    readline \
    ripgrep \
    ruby-build \
    rustup \
    starship \
    tmux \
    wget \
    vim \
    xz \
    zsh

  if is_arch_desktop; then
    sudo pacman -Syu --noconfirm --needed \
      chromium \
      ghostty \
      lib32-mesa \
      steam \
      steam-native-runtime \
      ttf-liberation \
      wqy-zenhei \
      xorg-xev

    setup_avahi

    yay -S --noconfirm --needed \
      discord \
      slack-desktop
  fi

  yay -S --noconfirm --needed \
    autojump \
    nodenv \
    tmuxinator

  install_vim_packages

  rustup default stable
}

if is_arch_linux ; then
  install_arch
else
  install_stripe
fi
